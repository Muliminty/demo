<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Web-LLM Chat Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 12px 16px;
      background: #020617;
      border-bottom: 1px solid #1e293b;
      font-weight: bold;
    }

    #log {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .user { color: #38bdf8; }
    .bot { color: #a7f3d0; }

    footer {
      display: flex;
      padding: 12px;
      gap: 8px;
      border-top: 1px solid #1e293b;
      background: #020617;
    }

    input {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background: #334155;
      cursor: not-allowed;
    }

    #initProgress {
      padding: 12px 16px;
      background: #0f172a;
      border-bottom: 1px solid #1e293b;
    }

    #initProgress.hidden {
      display: none;
    }

    #status {
      font-size: 13px;
      margin-bottom: 8px;
      color: #94a3b8;
    }

    .progress-bar-wrap {
      height: 6px;
      background: #1e293b;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #38bdf8);
      border-radius: 3px;
      transition: width 0.2s ease;
      width: 0%;
    }

  </style>
</head>
<body>
  <header>ğŸ§  Web-LLM æœ¬åœ°èŠå¤©ï¼ˆQwen2.5-0.5Bï¼‰</header>

  <div id="initProgress">
    <div id="status">ğŸ“¦ æ­£åœ¨åŠ è½½æ¨¡å‹ï¼Œè¯·ç¨ç­‰â€¦</div>
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
  </div>

  <div id="log"></div>

  <footer>
    <input id="input" placeholder="è¾“å…¥ç‚¹ä»€ä¹ˆâ€¦" />
    <button id="send" disabled>å‘é€</button>
  </footer>

  <script type="module">
    import { CreateMLCEngine } from "https://esm.sh/@mlc-ai/web-llm";

    const modelId = "Qwen2.5-0.5B-Instruct-q4f32_1-MLC";

    const logEl = document.getElementById("log");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const statusEl = document.getElementById("status");
    const progressFillEl = document.getElementById("progressFill");
    const initProgressEl = document.getElementById("initProgress");

    function append(role, text) {
      const div = document.createElement("div");
      div.className = role;
      div.textContent = (role === "user" ? "ä½ : " : "ğŸ¤–: ") + text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    const engine = await CreateMLCEngine(modelId, {
      initProgressCallback: (p) => {
        const percent = (p.progress !== undefined) ? Math.round(p.progress * 100) : 0;
        statusEl.textContent = p.text ? "ğŸ“¦ " + p.text : "ğŸ“¦ åŠ è½½ä¸­â€¦";
        progressFillEl.style.width = percent + "%";
      },
    });

    initProgressEl.classList.add("hidden");
    statusEl.textContent = "âœ… æ¨¡å‹å·²å°±ç»ªï¼Œå¯ä»¥èŠå¤©äº†";
    sendBtn.disabled = false;

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;

      inputEl.value = "";
      append("user", text);
      sendBtn.disabled = true;

      const res = await engine.chat.completions.create({
        messages: [{ role: "user", content: text }],
      });

      append("bot", res.choices[0].message.content);
      sendBtn.disabled = false;
    }

    sendBtn.onclick = send;
    inputEl.onkeydown = (e) => e.key === "Enter" && send();
  </script>
</body>
</html>
