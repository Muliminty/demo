<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H5 离开页面检测 Demo</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 24px;
    }

    .status {
      font-size: 18px;
      margin: 12px 0;
    }
  </style>
</head>

<body>
  <h1>H5 离开页面检测 Demo</h1>
  <div id="root"></div>

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;
    const BASE_TITLE = "H5 离开页面检测 Demo";

    /** useAwayTracker Hook */
    function useAwayTracker(onReturn) {
      const [isAway, setIsAway] = useState(false);
      const [awaySeconds, setAwaySeconds] = useState(0);

      const awayStartRef = useRef(null);
      const timerRef = useRef(null);

      const getCurrentAwaySeconds = useCallback(() => {
        if (!awayStartRef.current) return 0;
        return Math.floor((Date.now() - awayStartRef.current) / 1000);
      }, []);

      const reset = useCallback(() => {
        awayStartRef.current = null;
        setAwaySeconds(0);
        setIsAway(false);
      }, []);

      const markAway = useCallback((reason) => {
        if (awayStartRef.current) return; // 已经在离开状态
        awayStartRef.current = Date.now();
        setIsAway(true);
        document.title = `【离开中】${BASE_TITLE}`;

        timerRef.current = setInterval(() => {
          setAwaySeconds(getCurrentAwaySeconds());
        }, 1000);

        console.debug("[useAwayTracker] markAway:", reason, new Date().toISOString());
      }, [getCurrentAwaySeconds]);

      const markReturn = useCallback((reason) => {
        if (!awayStartRef.current) return;

        const seconds = Math.floor((Date.now() - awayStartRef.current) / 1000);
        clearInterval(timerRef.current);
        timerRef.current = null;
        awayStartRef.current = null;

        setAwaySeconds(seconds);
        setIsAway(false);
        document.title = BASE_TITLE;

        console.debug("[useAwayTracker] markReturn:", reason, "awaySeconds=", seconds);
        if (onReturn) onReturn(seconds, reason || "return");

        // 回来后 2 秒重置 awaySeconds 为 0（让 UI 回归）
        setTimeout(() => setAwaySeconds(0), 2000);
      }, [onReturn]);

      useEffect(() => {
        const handleVisibility = () => {
          if (document.hidden) {
            markAway("visibilitychange:hidden");
          } else {
            markReturn("visibilitychange:visible");
          }
        };

        document.addEventListener("visibilitychange", handleVisibility, true);
        window.addEventListener("blur", () => markAway("window:blur"), true);
        window.addEventListener("focus", () => markReturn("window:focus"), true);

        return () => {
          document.removeEventListener("visibilitychange", handleVisibility, true);
          window.removeEventListener("blur", () => markAway("window:blur"), true);
          window.removeEventListener("focus", () => markReturn("window:focus"), true);
          clearInterval(timerRef.current);
        };
      }, [markAway, markReturn]);

      return {
        isAway,
        awaySeconds,
        getCurrentAwaySeconds,
        reset,
      };
    }

    /** Demo 组件 */
    function Demo() {
      const { isAway, awaySeconds } = useAwayTracker((seconds, reason) => {
        console.log(`用户离开 ${seconds} 秒后回来（${reason}）`);
        if (seconds >= 10) {
          alert("检测到你离开超过 10 秒，自动刷新数据！");
        }
      });

      return (
        <div className="status">
          {isAway
            ? `当前离开中... 已离开 ${awaySeconds} 秒`
            : "当前页面活跃中 ✅"}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<Demo />);
  </script>
</body>

</html>
