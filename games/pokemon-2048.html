<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宝可梦 2048</title>
    <style>
        :root {
            --grid-size: 100px;
            --gap: 10px;
            --bg-color: #bbada0;
            --grid-bg: #cdc1b4;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #faf8ef;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        h1 {
            color: #776e65;
            font-size: 40px;
            margin-bottom: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            width: 450px;
            margin-bottom: 20px;
            align-items: center;
        }

        .score-container {
            background: #bbada0;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .score-label {
            font-size: 12px;
            color: #eee4da;
        }

        .score-val {
            font-size: 24px;
        }

        #game-board {
            width: calc(4 * var(--grid-size) + 5 * var(--gap));
            height: calc(4 * var(--grid-size) + 5 * var(--gap));
            background-color: var(--bg-color);
            border-radius: 10px;
            position: relative;
            padding: var(--gap);
            box-sizing: border-box;
            display: grid;
            grid-template-columns: repeat(4, var(--grid-size));
            grid-template-rows: repeat(4, var(--grid-size));
            gap: var(--gap);
        }

        /* 背景网格单元 */
        .grid-cell {
            width: var(--grid-size);
            height: var(--grid-size);
            background-color: var(--grid-bg);
            border-radius: 6px;
        }

        /* 实际移动的图块 */
        .tile {
            width: var(--grid-size);
            height: var(--grid-size);
            border-radius: 6px;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.15s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .tile img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .tile span {
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: 10px;
            color: rgba(0,0,0,0.5);
        }

        /* 不同数值的颜色样式 */
        .tile-2 { background: #eee4da; }
        .tile-4 { background: #ede0c8; }
        .tile-8 { background: #f2b179; } /* 雷系橙 */
        .tile-16 { background: #f59563; } /* 火系红 */
        .tile-32 { background: #f67c5f; }
        .tile-64 { background: #f65e3b; }
        .tile-128 { background: #edcf72; } /* 水系蓝/金 */
        .tile-256 { background: #edcc61; }
        .tile-512 { background: #edc850; }
        .tile-1024 { background: #edc53f; } /* 超梦紫 */
        .tile-2048 { background: #edc22e; box-shadow: 0 0 10px gold;}

        .game-over {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(238, 228, 218, 0.73);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            font-size: 30px;
            font-weight: bold;
            color: #776e65;
            border-radius: 10px;
            display: none; /* 默认隐藏 */
        }

        button {
            background-color: #8f7a66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #7f6a56;
        }

        .tips {
            margin-top: 20px;
            color: #776e65;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1>宝可梦 2048</h1>
            <button onclick="initGame()">新游戏</button>
        </div>
        <div class="score-container">
            <div class="score-label">分数</div>
            <div class="score-val" id="score">0</div>
        </div>
    </div>

    <div id="game-board">
        <!-- 16个背景格子 -->
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        
        <!-- 游戏结束遮罩 -->
        <div class="game-over" id="game-over-overlay">
            <p id="game-msg">游戏结束!</p>
            <button onclick="initGame()">再试一次</button>
        </div>
    </div>

    <div class="tips">使用 <b>方向键</b> 或 <b>WASD</b> 移动方块</div>

<script>
    // 宝可梦数据映射 (数值 -> ID 和 颜色偏好)
    // 图片使用 PokeAPI
    const POKEMON_MAP = {
        2: { name: '皮丘', id: 172 },
        4: { name: '皮卡丘', id: 25 },
        8: { name: '雷丘', id: 26 },
        16: { name: '小火龙', id: 4 },
        32: { name: '火恐龙', id: 5 },
        64: { name: '喷火龙', id: 6 },
        128: { name: '杰尼龟', id: 7 },
        256: { name: '卡咪龟', id: 8 },
        512: { name: '水箭龟', id: 9 },
        1024: { name: '超梦', id: 150 },
        2048: { name: '梦幻', id: 151 },
        4096: { name: '阿尔宙斯', id: 493 }
    };

    let board = [];
    let score = 0;
    const size = 4;
    const boardElement = document.getElementById('game-board');
    const scoreElement = document.getElementById('score');
    const gameOverOverlay = document.getElementById('game-over-overlay');
    const gameMsg = document.getElementById('game-msg');

    // 初始化游戏
    function initGame() {
        board = Array(size * size).fill(0);
        score = 0;
        scoreElement.innerText = 0;
        gameOverOverlay.style.display = 'none';
        
        // 清除旧的 tile 元素 (保留 grid-cell 和 overlay)
        const tiles = document.querySelectorAll('.tile');
        tiles.forEach(t => t.remove());

        spawnTile();
        spawnTile();
        renderBoard();
    }

    // 生成新方块
    function spawnTile() {
        let emptyCells = [];
        for (let i = 0; i < board.length; i++) {
            if (board[i] === 0) emptyCells.push(i);
        }
        if (emptyCells.length === 0) return;

        let randIdx = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        board[randIdx] = Math.random() < 0.9 ? 2 : 4;
    }

    // 渲染界面
    function renderBoard() {
        // 移除旧DOM
        const oldTiles = document.querySelectorAll('.tile');
        oldTiles.forEach(t => t.remove());

        board.forEach((value, index) => {
            if (value === 0) return;

            const tile = document.createElement('div');
            tile.classList.add('tile', `tile-${value}`);
            
            // 计算位置 (top/left)
            const row = Math.floor(index / size);
            const col = index % size;
            const gap = 10;
            const gridSize = 100;
            
            tile.style.left = (col * (gridSize + gap) + gap) + 'px';
            tile.style.top = (row * (gridSize + gap) + gap) + 'px';

            // 添加宝可梦图片
            if (POKEMON_MAP[value]) {
                const img = document.createElement('img');
                img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${POKEMON_MAP[value].id}.png`;
                tile.appendChild(img);
                
                // (可选) 右下角显示数字辅助
                const numSpan = document.createElement('span');
                numSpan.innerText = value;
                tile.appendChild(numSpan);
            } else {
                tile.innerText = value;
            }

            boardElement.appendChild(tile);
        });
    }

    // 核心逻辑：移动与合并
    function move(direction) {
        let hasMoved = false;
        
        // 将一维数组转为二维，方便计算
        let grid = [];
        for(let r=0; r<size; r++) {
            let row = [];
            for(let c=0; c<size; c++) {
                row.push(board[r*size + c]);
            }
            grid.push(row);
        }

        // 旋转矩阵以复用 "向左移动" 的逻辑
        if (direction === 'right') grid = rotateGrid(grid, 2); // 相当于水平翻转逻辑（这里简化处理，先用旋转）
        else if (direction === 'up') grid = rotateGrid(grid, 3); // 逆时针90度 (实际是左旋)
        else if (direction === 'down') grid = rotateGrid(grid, 1); // 顺时针90度

        // 对每一行执行向左合并
        for (let r = 0; r < size; r++) {
            let row = grid[r];
            // 1. 移除0
            let filtered = row.filter(val => val !== 0);
            
            // 2. 合并
            for (let c = 0; c < filtered.length - 1; c++) {
                if (filtered[c] === filtered[c+1]) {
                    filtered[c] *= 2;
                    score += filtered[c];
                    filtered[c+1] = 0;
                    c++; // 跳过下一个，因为已合并
                }
            }
            
            // 3. 再次移除0并补齐
            filtered = filtered.filter(val => val !== 0);
            while (filtered.length < size) {
                filtered.push(0);
            }
            
            if (grid[r].join(',') !== filtered.join(',')) {
                hasMoved = true;
            }
            grid[r] = filtered;
        }

        // 还原矩阵方向
        if (direction === 'right') grid = rotateGrid(grid, 2);
        else if (direction === 'up') grid = rotateGrid(grid, 1); // 还原up (之前转了3，现在转1回到0)
        else if (direction === 'down') grid = rotateGrid(grid, 3); // 还原down (之前转了1，现在转3)

        // 更新全局board
        for(let r=0; r<size; r++) {
            for(let c=0; c<size; c++) {
                board[r*size + c] = grid[r][c];
            }
        }

        if (hasMoved) {
            spawnTile();
            renderBoard();
            scoreElement.innerText = score;
            checkStatus();
        }
    }

    // 矩阵顺时针旋转90度 n 次
    function rotateGrid(grid, times) {
        let newGrid = JSON.parse(JSON.stringify(grid));
        for (let t = 0; t < times; t++) {
            let temp = Array.from({length: size}, () => Array(size).fill(0));
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    temp[c][size - 1 - r] = newGrid[r][c];
                }
            }
            newGrid = temp;
        }
        return newGrid;
    }

    // 键盘事件监听
    document.addEventListener('keydown', (e) => {
        if (gameOverOverlay.style.display === 'flex') return;
        
        switch(e.key) {
            case 'ArrowLeft': 
            case 'a':
            case 'A':
                move('left'); break;
            case 'ArrowRight': 
            case 'd':
            case 'D':
                move('right'); break;
            case 'ArrowUp': 
            case 'w':
            case 'W':
                move('up'); break;
            case 'ArrowDown': 
            case 's':
            case 'S':
                move('down'); break;
        }
    });

    // 检查游戏状态
    function checkStatus() {
        // 检查胜利
        if (board.includes(2048)) {
            // 这里可以做一个标记，只提示一次，为了简单先不中断
            // gameMsg.innerText = "恭喜！你抓到了梦幻！";
            // gameOverOverlay.style.display = 'flex';
        }

        // 检查失败 (没有0且无法合并)
        if (!board.includes(0)) {
            let canMove = false;
            // 检查水平相邻
            for (let i = 0; i < size * size; i++) {
                // 右侧
                if ((i + 1) % size !== 0) {
                    if (board[i] === board[i+1]) canMove = true;
                }
                // 下方
                if (i + size < size * size) {
                    if (board[i] === board[i+size]) canMove = true;
                }
            }
            
            if (!canMove) {
                gameMsg.innerText = "游戏结束!";
                gameOverOverlay.style.display = 'flex';
            }
        }
    }

    // 启动
    initGame();

</script>
</body>
</html>