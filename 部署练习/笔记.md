# Docker + Nginx 部署配置完整指南

## 一、核心关联逻辑

Docker 与 Nginx 配置的关联核心是：**通过 `volumes` 挂载，将宿主机的 Nginx 配置文件映射到容器内 Nginx 的配置路径，让容器内的 Nginx 服务读取并使用这个配置**。

**两种关联方式**：
1. **构建镜像时嵌入**：把 Nginx 配置文件打包进 Docker 镜像（适合配置固定的场景）
2. **运行容器时挂载**：通过 Docker Compose 的 `volumes` 字段挂载（推荐，配置修改后无需重新构建镜像）

---

## 二、当前项目配置（实际配置）

### 1. 项目文件结构

```
docker_ng_demo/
├── docker-compose.yml    # Docker Compose 核心配置
├── nginx/                # Nginx 配置目录
│   ├── nginx.conf        # Nginx 站点配置文件（核心）
│   └── logs/             # Nginx 日志目录
│       ├── access.log
│       ├── error.log
│       ├── app_access.log
│       └── app_error.log
└── app/                  # 业务代码目录
    └── index.html        # 测试页面
```

### 2. 关键配置文件

#### （1）Nginx 站点配置：`nginx/nginx.conf`

**重要说明**：此文件是站点配置（`server` 块），不是 Nginx 主配置文件。在 `docker-compose.yml` 中会被挂载为 `/etc/nginx/conf.d/app.conf`。

```nginx
server {
    listen 4040;
    server_name localhost;  # 可替换为你的域名，如 www.example.com

    # 字符编码设置
    charset utf-8;

    # 访问日志（容器内路径，已挂载到宿主机）
    access_log /var/log/nginx/app_access.log;
    error_log /var/log/nginx/app_error.log;

    # 根目录和默认页面（对应容器内的业务代码路径）
    root /usr/share/nginx/html;
    index index.html index.htm;

    # 反向代理示例（如果你的业务是后端服务，比如 Node.js/Java）
    # location /api/ {
    #     proxy_pass http://backend:8080;  # backend 对应 docker-compose 里的服务名
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    # }
}
```

#### （2）Docker Compose 配置：`docker-compose.yml`

```yaml
services:
  # Nginx 服务
  nginx:
    # 使用官方 Nginx 镜像（无需自己构建，除非有定制需求）
    image: nginx:alpine  # alpine 版本更小，推荐
    # 容器名称（方便管理）
    container_name: my-nginx
    # 端口映射：宿主机 4040 端口 → 容器 4040 端口
    ports:
      - "4040:4040"
      # 如果需要 HTTPS，再加 443 端口：- "443:443"
    # 核心：挂载 Nginx 配置和业务代码到容器内
    volumes:
      # 将 nginx.conf 挂载为站点配置文件（关键配置）
      # 注意：nginx.conf 是站点配置（server 块），不是主配置文件
      - ./nginx/nginx.conf:/etc/nginx/conf.d/app.conf
      # 挂载你的业务代码到容器内 Nginx 的默认静态文件目录
      - ./app:/usr/share/nginx/html
      # 挂载 Nginx 日志到宿主机，方便查看
      - ./nginx/logs:/var/log/nginx
    # 容器重启策略：异常退出时自动重启
    restart: always
    # 网络模式（默认桥接，无需修改）
    networks:
      - app-network

  # 可选：你的后端服务（比如 Node.js/Java/Python）
  # backend:
  #   build: ./backend  # 指向后端代码的 Dockerfile 目录
  #   container_name: my-backend
  #   restart: always
  #   networks:
  #     - app-network

# 自定义网络（让 Nginx 和后端服务互通）
networks:
  app-network:
    driver: bridge
```

**关键配置说明**：
- `./nginx/nginx.conf:/etc/nginx/conf.d/app.conf`：将本地的 `nginx.conf`（站点配置）挂载为容器内的站点配置文件
- `./app:/usr/share/nginx/html`：将业务代码挂载到 Nginx 默认静态文件目录
- `./nginx/logs:/var/log/nginx`：将日志挂载到宿主机，方便查看

#### （3）测试页面：`app/index.html`

```html
<!DOCTYPE html>
<html>
<head>
    <title>Test Page</title>
    <meta charset="utf-8">
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e0ecff 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        .container {
            background: #fff;
            padding: 40px 60px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(60, 122, 245, 0.13), 0 2px 8px rgba(60, 122, 245, 0.07);
        }
        h1 {
            color: #3978f3;
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 1px;
            margin: 0;
        }
        .subtitle {
            color: #41536b;
            text-align: center;
            font-size: 1.1em;
            margin-top: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>部署成功！Docker + Nginx 配置已生效</h1>
        <div class="subtitle">现在你可以自定义页面内容或继续开发你的前端项目。</div>
    </div>
</body>
</html>
```

---

## 三、完整部署步骤

### 1. 启动服务

进入项目目录，执行命令：

```bash
# 进入项目目录
cd /Users/muliminty/project/demo/部署练习/docker_ng_demo

# 启动并后台运行（-d 是后台模式）
docker compose up -d

# 查看容器状态（确认 nginx 容器是 running 状态）
docker compose ps

# 查看 Nginx 日志（排查问题用）
docker compose logs nginx
```

### 2. 验证部署

打开浏览器，访问：

```
http://localhost:4040
```

如果看到「部署成功！Docker + Nginx 配置已生效」，说明配置关联和部署都成功了。

### 3. 常用运维命令

```bash
# 停止服务
docker compose down

# 修改 Nginx 配置后，重启 Nginx 容器（无需重建镜像）
docker compose restart nginx

# 重新加载 Nginx 配置（不重启容器，推荐）
docker compose exec nginx nginx -s reload

# 测试 Nginx 配置是否正确
docker compose exec nginx nginx -t

# 查看 Nginx 容器内的配置（验证挂载是否生效）
docker compose exec nginx cat /etc/nginx/conf.d/app.conf

# 查看容器日志
docker compose logs nginx

# 查看实时日志
docker compose logs -f nginx
```

### 4. 修改配置后重新加载

**情况 1：只修改了 Nginx 配置文件（nginx.conf）**

```bash
# 方式 A：重新加载配置（推荐，无需重启容器）
docker compose exec nginx nginx -s reload

# 方式 B：重启容器
docker compose restart nginx
```

**情况 2：修改了 docker-compose.yml（如端口映射）**

```bash
# 需要重新创建容器
docker compose down
docker compose up -d
```

**情况 3：修改了应用代码（app/index.html）**

由于是挂载方式，**无需重启**，刷新浏览器即可看到变化。

---

## 四、常见问题排查

### 1. 容器不断重启

**原因**：Nginx 配置错误，导致容器启动失败。

**排查步骤**：
```bash
# 查看容器日志
docker compose logs nginx

# 测试 Nginx 配置
docker compose exec nginx nginx -t
```

**常见错误**：
- 将站点配置（`server` 块）挂载为 `/etc/nginx/nginx.conf`（主配置文件）
- 配置语法错误

**解决方案**：
- 确保 `nginx.conf` 挂载为 `/etc/nginx/conf.d/app.conf`，而不是主配置文件

### 2. 无法访问 http://localhost:4040

**排查步骤**：
```bash
# 1. 检查容器状态
docker compose ps

# 2. 检查端口映射
docker compose ps  # 查看 PORTS 列，确认 0.0.0.0:4040->4040/tcp

# 3. 检查 Nginx 配置
docker compose exec nginx nginx -t

# 4. 查看错误日志
docker compose logs nginx
# 或查看宿主机日志文件
cat nginx/logs/error.log
```

**常见原因**：
- 端口被占用
- Nginx 配置中的 `listen` 端口与 `docker-compose.yml` 中的端口映射不一致
- 配置文件未正确挂载

### 3. 配置文件修改后不生效

**原因**：配置文件已修改，但 Nginx 未重新加载。

**解决方案**：
```bash
# 重新加载配置（推荐）
docker compose exec nginx nginx -s reload

# 或重启容器
docker compose restart nginx
```

### 4. 访问 404 错误

**排查步骤**：
```bash
# 检查文件是否存在
docker compose exec nginx ls -la /usr/share/nginx/html

# 检查 index.html 是否存在
docker compose exec nginx cat /usr/share/nginx/html/index.html
```

**常见原因**：
- `app` 目录未正确挂载
- `index.html` 文件不存在或路径错误

---

## 五、配置说明

### 1. 端口配置

当前配置使用 **4040 端口**：
- `docker-compose.yml` 中：`ports: - "4040:4040"`
- `nginx.conf` 中：`listen 4040;`

**修改端口**：
- 修改 `docker-compose.yml` 中的端口映射
- 修改 `nginx.conf` 中的 `listen` 端口
- 两者必须一致

### 2. 配置文件挂载方式

**当前方式**：直接将 `nginx.conf` 挂载为站点配置
```yaml
- ./nginx/nginx.conf:/etc/nginx/conf.d/app.conf
```

**优点**：
- 简单直接，无需创建 `conf.d` 目录
- 配置文件修改后只需重新加载即可生效

**替代方式**：使用 `conf.d` 目录结构
```yaml
# 创建 nginx/conf.d/app.conf 文件
# 然后在 docker-compose.yml 中：
- ./nginx/conf.d:/etc/nginx/conf.d
```

### 3. 日志文件

日志文件已挂载到宿主机：
- 访问日志：`nginx/logs/app_access.log`
- 错误日志：`nginx/logs/app_error.log`
- 默认日志：`nginx/logs/access.log`、`nginx/logs/error.log`

---

## 六、两种关联方式对比

| 方式 | 配置方式 | 优点 | 缺点 |
|------|----------|------|------|
| **挂载式（推荐）** | `volumes` 挂载宿主机配置到容器 | 配置修改后重启容器即可生效，无需重构镜像 | 需保证宿主机配置文件路径正确 |
| **嵌入式** | 把 Nginx 配置复制到 Dockerfile 中，构建镜像 | 镜像包含完整配置，部署时无需携带配置文件 | 修改配置需重新构建镜像，灵活性低 |

**嵌入式示例（了解即可）**：
```dockerfile
# 自定义 Nginx 镜像的 Dockerfile
FROM nginx:alpine
# 复制本地 Nginx 配置到容器内
COPY ./nginx/nginx.conf /etc/nginx/conf.d/app.conf
COPY ./app /usr/share/nginx/html
```
然后在 `docker-compose.yml` 中用 `build: .` 替代 `image: nginx:alpine`。

---

## 七、总结

1. **核心关联**：Docker 与 Nginx 配置通过 `volumes` 挂载关联，将宿主机的配置文件映射到容器内
2. **部署步骤**：准备配置文件 → 执行 `docker compose up -d` 启动 → 验证访问
3. **推荐方式**：使用「挂载式」关联配置，修改配置后只需重启容器或重新加载配置，无需重构镜像，运维更灵活
4. **当前配置**：使用 4040 端口，直接将 `nginx.conf` 挂载为站点配置文件

### 扩展：添加后端服务

如果你的项目有后端服务（比如 Java/Node.js），只需：
1. 在 `docker-compose.yml` 中添加后端服务配置
2. 在 Nginx 的 `nginx.conf` 中用 `proxy_pass` 代理到后端服务名（如 `http://backend:8080`）
3. 整个网络互通由 Docker Compose 的自定义网络自动实现

---

## 八、注意事项

1. **版本警告**：`version: '3.8'` 在新版 Docker Compose 中已过时，可以删除（不影响使用）
2. **配置文件类型**：`nginx.conf` 是站点配置（`server` 块），不是主配置文件，不要挂载为 `/etc/nginx/nginx.conf`
3. **端口一致性**：确保 `docker-compose.yml` 中的端口映射与 `nginx.conf` 中的 `listen` 端口一致
4. **文件路径**：确保挂载的目录和文件路径正确，否则容器无法启动
