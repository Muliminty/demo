# 部署指南

## 完整部署步骤

### 步骤 1：搭建 Next.js 项目

使用 Next.js 官方脚手架创建项目：

```bash
cd /Users/muliminty/project/demo/部署练习/docker_ng_next

# 如果目录中有文件，先临时移动
mv 小记.md ../小记.md.bak 2>/dev/null || true

# 使用官方脚手架创建项目（在当前目录）
npx create-next-app@latest . --typescript --tailwind --app --no-src-dir --import-alias "@/*"
```

### 步骤 2：配置 Next.js（启用 Standalone 模式）

> **什么是 Standalone？**
>
> Standalone（独立模式）是 Next.js 提供的一种构建输出方式。当开启该模式后，Next.js 会自动分析应用的依赖，仅导出运行生产环境所需的最小文件和 Node.js 依赖，从而优化体积，并便于在 Docker 等环境中进行部署。这样打包出来的"独立包"无需复制整个项目，只需少量文件就能部署和运行。

修改 `next.config.ts`，添加 `output: 'standalone'` 配置：

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: 'standalone', // 启用 standalone 模式，适合 Docker 部署
};

export default nextConfig;
```

**说明**：standalone 模式会生成最小化的构建输出，只包含运行应用所需的文件，大幅减小 Docker 镜像体积。

### 步骤 3：什么是 Dockerfile？

**Dockerfile** 是一个文本文件，其中包含了一组指令，描述了如何自动化构建 Docker 镜像。通过 Dockerfile，可以定义基础操作系统镜像、需要安装的软件环境、要复制的应用程序文件、环境变量设置、执行命令等。Docker 会根据 Dockerfile 的内容一步步搭建出可移植、可复现的运行环境，最后生成一个镜像，方便本地部署、测试和线上发布。

在项目根目录创建 `Dockerfile`：

```dockerfile
# 构建阶段
FROM node:20-alpine AS builder

WORKDIR /app

# 复制 package 文件
COPY package.json package-lock.json* ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建 Next.js 应用
RUN npm run build

# 运行阶段
FROM node:20-alpine AS runner

WORKDIR /app

ENV NODE_ENV production

# 创建非 root 用户
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# 从构建阶段复制必要文件
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

**关键点**：
- 多阶段构建：builder 阶段构建应用，runner 阶段运行应用
- 只复制必要文件：使用 standalone 模式，只需复制 `.next/standalone` 和静态文件
- 非 root 用户运行：提高安全性

### 步骤 4：创建 docker-compose.yml

创建 `docker-compose.yml` 文件：

```yaml
services:
  # Next.js 应用服务
  nextjs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nextjs-app
    restart: always
    networks:
      - app-network
    # 不直接暴露端口，只通过 Nginx 访问

  # Nginx 反向代理服务
  nginx:
    image: nginx:alpine
    container_name: nextjs-nginx
    ports:
      - "4041:4041"
    volumes:
      # 挂载 Nginx 配置文件
      - ./nginx/nginx.conf:/etc/nginx/conf.d/app.conf
      # 挂载 Nginx 日志到宿主机
      - ./nginx/logs:/var/log/nginx
    restart: always
    depends_on:
      - nextjs
    networks:
      - app-network

# 自定义网络（让 Nginx 和 Next.js 服务互通）
networks:
  app-network:
    driver: bridge
```

**关键配置**：
- `nextjs` 服务：构建和运行 Next.js 应用，不直接暴露端口
- `nginx` 服务：反向代理，对外暴露 4041 端口
- `depends_on`：确保 Next.js 服务先启动
- 自定义网络：服务间通过服务名（`nextjs`）通信

### 步骤 5：创建 Nginx 配置

创建 `nginx` 目录和配置文件：

```bash
mkdir -p nginx/logs
```

创建 `nginx/nginx.conf`：

```nginx
server {
    listen 4041;
    server_name localhost;

    # 字符编码设置
    charset utf-8;

    # 访问日志
    access_log /var/log/nginx/app_access.log;
    error_log /var/log/nginx/app_error.log;

    # 反向代理到 Next.js 服务
    location / {
        proxy_pass http://nextjs:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存（Next.js 自动处理）
    location /_next/static {
        proxy_pass http://nextjs:3000;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, immutable";
    }
}
```

**关键配置**：
- `proxy_pass http://nextjs:3000`：通过服务名 `nextjs` 访问 Next.js 服务
- WebSocket 支持：`Upgrade` 和 `Connection` 头，支持 HMR 等功能
- 静态资源缓存：优化 `/_next/static` 路径的缓存策略

### 步骤 6：创建辅助文件

#### `.dockerignore` 是什么，有什么用？

`.dockerignore` 文件用于告诉 Docker 在构建镜像时忽略哪些文件和目录。这样可以减少构建镜像时的上下文大小，加快构建速度，并确保像 `node_modules`、日志文件、本地开发环境变量等敏感或无关文件不会被打包进最终镜像，从而提升安全性和生产环境的干净整洁度。

在项目根目录创建 `.dockerignore`：

```
Dockerfile
.dockerignore
node_modules
npm-debug.log
README.md
.env
.env.local
.env.production.local
.env.development.local
.git
.gitignore
.next
.vercel
.DS_Store
*.log
nginx/
```

#### 更新 `.gitignore`

在 `.gitignore` 文件末尾添加：

```
# nginx logs
nginx/logs/
```

### 步骤 7：部署启动

```bash
cd /Users/muliminty/project/demo/部署练习/docker_ng_next

# 1. 创建 nginx 日志目录（如果还没有）
mkdir -p nginx/logs

# 2. 构建并启动所有服务
docker compose up -d --build

# 3. 查看容器状态
docker compose ps

# 4. 查看日志
docker compose logs -f nextjs
docker compose logs -f nginx
```

访问：`http://localhost:4041`
