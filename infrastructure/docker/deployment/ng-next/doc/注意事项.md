# 注意事项

## 1. Standalone 模式要求

- **必须配置**：`next.config.ts` 中必须设置 `output: 'standalone'`
- **文件复制**：Dockerfile 中必须正确复制 `.next/standalone` 和 `.next/static` 目录
- **server.js**：standalone 模式会自动生成 `server.js`，Dockerfile 中直接运行即可

## 2. 端口配置一致性

确保以下配置中的端口一致：
- `docker-compose.yml`：`ports: - "4041:4041"`
- `nginx/nginx.conf`：`listen 4041;`
- `nginx/nginx.conf`：`proxy_pass http://nextjs:3000;`（Next.js 默认 3000 端口）

## 3. 环境变量管理

- 使用 `.env` 文件配置环境变量（记得添加到 `.gitignore`）
- 在 `docker-compose.yml` 中通过 `environment` 字段传递环境变量
- Next.js 会自动读取容器内的环境变量

示例：
```yaml
environment:
  - NODE_ENV=production
  - NEXT_PUBLIC_API_URL=https://api.example.com
```

## 4. 日志文件管理

- Nginx 日志已挂载到 `nginx/logs/` 目录
- 日志文件已被 `.gitignore` 忽略，不会提交到 git
- 定期清理日志文件，避免占用过多磁盘空间

## 5. 性能优化建议

- **静态资源**：Next.js 会自动优化静态资源，Nginx 配置了缓存策略
- **镜像大小**：使用 standalone 模式和多阶段构建，大幅减小镜像体积
- **构建缓存**：Docker 会缓存构建层，只有代码变更时才重新构建

## 6. 安全建议

- **非 root 用户运行**：Dockerfile 中已创建非 root 用户运行应用
- **不直接暴露端口**：Next.js 服务不直接对外暴露，只通过 Nginx 访问
- **敏感文件**：确保 `.env`、`.dockerignore` 等敏感文件不被提交到 git

## 7. 配置文件挂载

**重要**：`nginx.conf` 是站点配置（`server` 块），不是主配置文件，应挂载为：
- ✅ 正确：`./nginx/nginx.conf:/etc/nginx/conf.d/app.conf`
- ❌ 错误：`./nginx/nginx.conf:/etc/nginx/nginx.conf`（会导致容器启动失败）

## 8. 网络通信

- 服务间通过 Docker Compose 自定义网络通信
- 使用服务名（如 `nextjs`）而不是 IP 地址访问
- 确保 `depends_on` 配置正确，保证服务启动顺序

## 9. 构建缓存

- Docker 会缓存构建层，提高构建速度
- 如果遇到构建问题，可以使用 `--no-cache` 强制重新构建
- 依赖变更时会自动重新构建相关层

## 10. 容器重启策略

- 已配置 `restart: always`，容器异常退出时会自动重启
- 如果容器不断重启，检查日志找出问题原因
