# 故障排查

## 1. 容器无法启动

**排查步骤**：
```bash
# 查看容器日志
docker compose logs nextjs
docker compose logs nginx

# 检查 Dockerfile 构建是否成功
docker compose build --no-cache

# 测试 Nginx 配置
docker compose exec nginx nginx -t
```

**常见原因**：
- Next.js 构建失败：检查 `next.config.ts` 是否正确配置 `output: 'standalone'`
- 端口被占用：修改 `docker-compose.yml` 中的端口映射
- 配置文件错误：检查 `nginx/nginx.conf` 语法

## 2. 无法访问 http://localhost:4041

**排查步骤**：
```bash
# 1. 检查容器状态
docker compose ps

# 2. 检查端口映射
docker compose ps  # 查看 PORTS 列，确认 0.0.0.0:4041->4041/tcp

# 3. 检查 Next.js 服务是否正常运行
docker compose exec nextjs ps aux

# 4. 检查 Nginx 配置
docker compose exec nginx nginx -t

# 5. 查看错误日志
docker compose logs nginx
cat nginx/logs/error.log
```

**常见原因**：
- Next.js 服务未启动：检查 `docker compose logs nextjs`
- Nginx 配置错误：检查 `proxy_pass` 地址是否正确（`http://nextjs:3000`）
- 端口不一致：确保 `nginx.conf` 中的 `listen` 端口与 `docker-compose.yml` 中的端口映射一致

## 3. 配置修改后不生效

**Next.js 代码修改**：
- 需要重新构建镜像：`docker compose down && docker compose build && docker compose up -d`
- 或使用：`docker compose up -d --build`

**Nginx 配置修改**：
- 重新加载配置：`docker compose exec nginx nginx -s reload`
- 或重启容器：`docker compose restart nginx`

## 4. 常见错误

**错误：Cannot find module 'server.js'**
- **原因**：未启用 standalone 模式
- **解决**：在 `next.config.ts` 中添加 `output: 'standalone'`

**错误：connect() failed (111: Connection refused)**
- **原因**：Next.js 服务未启动或网络配置错误
- **解决**：检查 `docker compose ps`，确认 nextjs 服务运行正常

**错误：nginx: [emerg] bind() to 0.0.0.0:4041 failed (98: Address already in use)**
- **原因**：端口被占用
- **解决**：修改 `docker-compose.yml` 中的端口映射，或停止占用端口的进程

**错误：容器不断重启**
- **原因**：Nginx 配置错误或 Next.js 构建失败
- **解决**：
  1. 查看日志：`docker compose logs nginx` 或 `docker compose logs nextjs`
  2. 检查配置：`docker compose exec nginx nginx -t`
  3. 确保 `nginx.conf` 挂载为站点配置，而不是主配置文件
