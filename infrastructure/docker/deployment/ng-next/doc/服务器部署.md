# 服务器部署指南

本文档介绍如何将 Next.js + Docker + Nginx 项目部署到生产服务器（云服务器、VPS 等）。

## 前置要求

### 服务器要求

- **操作系统**：Linux（推荐 Ubuntu 20.04+ 或 CentOS 7+）
- **内存**：至少 2GB RAM（推荐 4GB+）
- **磁盘空间**：至少 10GB 可用空间
- **网络**：公网 IP 地址，开放所需端口

### 需要安装的软件

- Docker（版本 20.10+）
- Docker Compose（版本 2.0+）
- Git（用于拉取代码）

## 步骤 1：服务器环境准备

### 1.1 连接到服务器

使用 SSH 连接到你的服务器：

```bash
ssh username@your-server-ip
```

### 1.2 安装 Docker

#### Ubuntu/Debian 系统

```bash
# 更新包索引
sudo apt-get update

# 安装必要的依赖
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# 添加 Docker 官方 GPG 密钥
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 设置 Docker 仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker Engine
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
docker compose version
```

#### CentOS/RHEL 系统

```bash
# 安装必要的依赖
sudo yum install -y yum-utils

# 添加 Docker 仓库
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 安装 Docker Engine
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
docker compose version
```

### 1.3 配置 Docker 用户权限（可选但推荐）

将当前用户添加到 docker 组，避免每次使用 `sudo`：

```bash
# 添加用户到 docker 组
sudo usermod -aG docker $USER

# 重新登录或执行以下命令使权限生效
newgrp docker

# 验证（应该不需要 sudo）
docker ps
```

### 1.4 安装 Git（如果未安装）

```bash
# Ubuntu/Debian
sudo apt-get install -y git

# CentOS/RHEL
sudo yum install -y git
```

## 步骤 2：上传项目到服务器

### 方式 1：使用 Git（推荐）

如果项目已托管在 Git 仓库（GitHub、GitLab 等）：

```bash
# 在服务器上创建项目目录
mkdir -p ~/projects
cd ~/projects

# 克隆项目
git clone https://github.com/your-username/your-repo.git docker_ng_next
cd docker_ng_next
```

### 方式 2：使用 SCP 上传

如果项目在本地，使用 SCP 上传：

```bash
# 在本地机器执行
scp -r /path/to/docker_ng_next username@your-server-ip:~/projects/
```

### 方式 3：使用 rsync（推荐用于更新）

**什么是 rsync？**

rsync 是一个用于本地与远程文件/目录高效同步和传输的工具。它只同步变动的部分，支持断点续传、排除特定文件，常用于项目更新和增量备份，尤其适合传输较大的目录或经常更新的项目。

```bash
# 在本地机器执行，同步项目文件
rsync -avz --exclude 'node_modules' --exclude '.next' \
  /path/to/docker_ng_next/ username@your-server-ip:~/projects/docker_ng_next/
```

## 步骤 3：配置服务器环境

### 3.1 创建必要的目录

```bash
cd ~/projects/docker_ng_next

# 创建 Nginx 日志目录
mkdir -p nginx/logs
```

### 3.2 配置防火墙

开放必要的端口（根据你的实际需求）：

```bash
# Ubuntu/Debian (使用 ufw)
sudo ufw allow 4041/tcp
sudo ufw allow 22/tcp  # SSH 端口
sudo ufw enable
sudo ufw status

# CentOS/RHEL (使用 firewalld)
sudo firewall-cmd --permanent --add-port=4041/tcp
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-ports
```

### 3.3 配置域名（可选）

如果你有域名，需要：

1. **DNS 配置**：将域名 A 记录指向服务器 IP
2. **修改 Nginx 配置**：更新 `nginx/nginx.conf` 中的 `server_name`

```nginx
server {
    listen 4041;
    server_name your-domain.com www.your-domain.com;  # 修改这里
    
    # ... 其他配置保持不变
}
```

## 步骤 4：部署应用

### 4.1 构建并启动服务

```bash
cd ~/projects/docker_ng_next

# 构建并启动所有服务（后台运行）
docker compose up -d --build
```

### 4.2 查看部署状态

```bash
# 查看容器状态
docker compose ps

# 查看日志
docker compose logs -f nextjs
docker compose logs -f nginx
```

### 4.3 验证部署

访问你的服务器：

- **IP 访问**：`http://your-server-ip:4041`
- **域名访问**：`http://your-domain.com:4041`（如果配置了域名）

## 步骤 5：配置 SSL 证书（HTTPS，推荐）

### 5.1 使用 Let's Encrypt 免费证书

#### 安装 Certbot

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install -y certbot python3-certbot-nginx
```

#### 配置 Nginx 支持 HTTP（用于验证）

修改 `nginx/nginx.conf`，添加 HTTP 监听（端口 80）：

```nginx
# HTTP 服务器（用于 Let's Encrypt 验证）
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS 服务器
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL 证书配置（Certbot 会自动添加）
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 字符编码设置
    charset utf-8;
    
    # 访问日志
    access_log /var/log/nginx/app_access.log;
    error_log /var/log/nginx/app_error.log;
    
    # 反向代理到 Next.js 服务
    location / {
        proxy_pass http://nextjs:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 静态资源缓存
    location /_next/static {
        proxy_pass http://nextjs:3000;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 更新 docker-compose.yml

需要将证书目录挂载到 Nginx 容器：

```yaml
services:
  nginx:
    image: nginx:alpine
    container_name: nextjs-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/app.conf
      - ./nginx/logs:/var/log/nginx
      - /etc/letsencrypt:/etc/letsencrypt:ro  # 挂载 SSL 证书
      - /var/www/certbot:/var/www/certbot:ro  # Let's Encrypt 验证目录
    restart: always
    depends_on:
      - nextjs
    networks:
      - app-network
```

#### 获取 SSL 证书

```bash
# 重新启动 Nginx（使用新的配置）
docker compose up -d --build

# 获取证书
sudo certbot certonly --webroot \
  -w /var/www/certbot \
  -d your-domain.com \
  -d www.your-domain.com \
  --email your-email@example.com \
  --agree-tos \
  --non-interactive
```

#### 配置自动续期

```bash
# 测试续期
sudo certbot renew --dry-run

# 添加到 crontab（每月自动续期）
sudo crontab -e

# 添加以下行
0 0 1 * * certbot renew --quiet && docker compose restart nginx
```

### 5.2 更新防火墙规则

```bash
# 开放 HTTPS 端口
sudo ufw allow 443/tcp
sudo ufw allow 80/tcp
```

## 步骤 6：服务器维护

### 6.1 更新代码后重新部署

```bash
cd ~/projects/docker_ng_next

# 如果使用 Git
git pull origin main

# 重新构建并部署
docker compose up -d --build
```

### 6.2 查看日志

```bash
# 查看所有服务日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f nextjs
docker compose logs -f nginx

# 查看最近 100 行日志
docker compose logs --tail=100 nextjs
```

### 6.3 容器管理

```bash
# 停止服务
docker compose down

# 停止并删除卷（谨慎使用）
docker compose down -v

# 重启服务
docker compose restart

# 重启特定服务
docker compose restart nextjs
docker compose restart nginx
```

### 6.4 清理 Docker 资源

定期清理未使用的镜像和容器：

```bash
# 清理未使用的镜像、容器、网络
docker system prune -a

# 查看磁盘使用情况
docker system df
```

### 6.5 监控服务状态

```bash
# 查看容器资源使用情况
docker stats

# 查看容器详细信息
docker inspect nextjs-app
docker inspect nextjs-nginx
```

## 步骤 7：性能优化建议

### 7.1 配置 Nginx 缓存

在 `nginx/nginx.conf` 中添加缓存配置：

```nginx
# 在 http 块外添加（如果使用独立的配置文件）
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=nextjs_cache:10m max_size=1g inactive=60m use_temp_path=off;

server {
    # ... 其他配置
    
    location / {
        proxy_cache nextjs_cache;
        proxy_cache_valid 200 60m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        
        proxy_pass http://nextjs:3000;
        # ... 其他 proxy 配置
    }
}
```

### 7.2 配置 Docker 资源限制

在 `docker-compose.yml` 中添加资源限制：

```yaml
services:
  nextjs:
    # ... 其他配置
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

### 7.3 启用 Gzip 压缩

在 `nginx/nginx.conf` 中添加：

```nginx
server {
    # ... 其他配置
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json;
}
```

## 常见问题

### 问题 1：无法访问服务

**检查项**：
1. 防火墙是否开放端口
2. 容器是否正常运行：`docker compose ps`
3. 查看日志：`docker compose logs nginx`
4. 检查 Nginx 配置语法：`docker compose exec nginx nginx -t`

### 问题 2：SSL 证书续期失败

**解决方案**：
1. 确保域名 DNS 正确指向服务器
2. 确保端口 80 开放（Let's Encrypt 验证需要）
3. 检查证书目录权限

### 问题 3：容器频繁重启

**检查项**：
1. 查看容器日志：`docker compose logs nextjs`
2. 检查内存使用：`docker stats`
3. 检查应用代码是否有错误

### 问题 4：构建镜像失败

**解决方案**：
1. 检查 Dockerfile 语法
2. 确保网络连接正常（下载依赖）
3. 清理旧的构建缓存：`docker builder prune`

## 安全建议

1. **定期更新系统**：
   ```bash
   sudo apt-get update && sudo apt-get upgrade
   ```

2. **使用非 root 用户运行容器**（已在 Dockerfile 中配置）

3. **限制 SSH 访问**：
   - 禁用 root 登录
   - 使用密钥认证而非密码
   - 更改默认 SSH 端口

4. **定期备份**：
   - 备份项目代码
   - 备份数据库（如果有）
   - 备份配置文件

5. **监控日志**：
   - 定期检查 Nginx 访问日志
   - 监控异常请求

## 相关文档

- [部署指南](./部署指南.md) - 本地部署完整步骤
- [重新部署](./重新部署.md) - 更新代码后的部署流程
- [故障排查](./故障排查.md) - 常见问题解决方案
- [常用命令](./常用命令.md) - 日常运维命令参考
